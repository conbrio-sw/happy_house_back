<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Framework Project</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="shortcut icon" href="img/favicon.ico">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
	<link rel="stylesheet" href="/css/apt.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</head>
<body>
	<div class="container">
		<header id="index_header" class="jumbotron text-center mb-1">
			<img id="logo" src="/img/happyhouse.png">
		</header>
		<!-- nav start -->
		<nav class="navbar navbar-expand-sm bg-dark navbar-dark rounded">
			<ul class="navbar-nav">
				<li class="nav-item">
					<a class="nav-link" href="/">Home</a>
				</li>
				<li class="nav-item dropdown">
					<a class="nav-link dropdown-toggle" href="#dropdown-menu" id="navbardrop" data-toggle="dropdown">
						동네 정보
					</a>
					<div class="dropdown-menu">
						<a class="dropdown-item" href="#">APT 매매</a>
						<a class="dropdown-item" href="#">APT 전월세</a>
						<a class="dropdown-item" href="#">주택 매매</a>
						<a class="dropdown-item" href="#">주택 전월세</a>
						<a class="dropdown-item" href="#">상권 정보</a>
						<a class="dropdown-item" href="#">환경 정보</a>
					</div>
				</li>
				<li class="nav-item">
					<a class="nav-link" href="/notice">Notice</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" href="/shop">News</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" href="#">Contact</a>
				</li>
				<!--  테스트용
				<li class="nav-item">
					<a class="nav-link" href="/login">로그인</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" href="/logout">로그아웃</a>
				</li> -->
			</ul>
			<!-- login signup -->
			<ul id="login" class="navbar-nav">
				<li class="nav-item">
					<a class="nav-link" href="/login">Login</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" href="/register">SignUp</a>
				</li>
			</ul>
			
			<ul id="mypage" class="navbar-nav" style='display:none'>
				<li class="nav-item">
					<a class="nav-link" href="/mypage">MyPage</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" id="logout" href="/logout">Logout</a>
				</li>
			</ul>
		</nav>

		<section id="index_section">
			<div class="card col-sm-12 mt-1" style="min-height: 850px;">
				<div class="card-body">
					<div class="form-group form-inline justify-content-center">
						<label class="mr-2" for="sido">시도 : </label>
						<select class="form-control" id="sido">
							<option value="0">선택</option>
						</select>
						<label class="mr-2 ml-3" for="gugun">구군 : </label>
						<select class="form-control" id="gugun">
							<option value="0">선택</option>
						</select>
						<label class="mr-2 ml-3" for="dong">읍면동 : </label>
						<select class="form-control" id="dong">
							<option value="0">선택</option>
						</select>
						<button type="button" id="aptSearchBtn">검색</button> 
					</div>
					<!-- <div class="row">
					<table class="table mt-2 col-sm-3">
	
						<thead>
							<tr>
								<th>번호</th>
								<th>아파트이름</th>
								<th class="text-center">주소</th>
								<th>건축연도</th>
								<th>최근거래금액</th>
								<th>아파트 이름</th>
							</tr>
						</thead>
						<tbody id="searchResult"></tbody>
					</table>
				<div class="col-sm-9" id="map" style="width:100%;height:500px;"></div>
				</div> -->
				      <div class="row" style="margin:auto;">
               
               <div class="apartList" style="width:28%; margin-right:2%; height:550px; overflow:auto;">
	               <table class="table table-striped" style="line-height: 25px; ">
	   
	                  <thead>
	                     <tr>
	                        <!-- <th>번호</th>
	                        <th>아파트이름</th>
	                        <th class="text-center">주소</th>
	                        <th>건축연도</th>
	                        <th>최근거래금액</th> -->
	                        <th>아파트 이름</th>
	                     </tr>
	                  </thead>
	                  <tbody id="searchResult"></tbody>
	               </table>
	               </div>
	            <div  id="map" style=" width:69%; height:500px; margin-top:25px"></div>
	            
            </div>
				
				<!-- modal begin ------------------------------------------------------------------------->
    <!-- Modal insert-->
    <div class="modal" id="boardInsertModal">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <!-- Modal Header -->
          <div class="modal-header">
            <h4 class="modal-title">아파트 거래 리스트</h4>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
          <div class="row">
            <table class="table mt-2 col-sm-12 text-center table-striped">
						<colgroup> 
							<col width="100">
							<col width="150">
							<col width="*">
							<col width="120">
							<col width="120">
						</colgroup>	
						<thead>
							<tr>
								<th>번호</th>
								<th>아파트이름</th>
								<th class="text-center">주소</th>
								<th>건축연도</th>
								<th>최근거래금액</th>
							</tr>
						</thead>
						<tbody id="searchResultModal"></tbody>
					</table>
            
            </div>
           	
          </div>
        </div>
      </div>
    </div>
    <!-- End Modal -->
				
				
				
				
				
				
				<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=034dcc5ce4d542a740e6d5514a14db3e&libraries=services"></script>
				<script type="text/javascript" src="js/map_index.js"></script>
				<script type="text/javascript">
				
				//회원인지 확인하고 회원이면 mypage 보이고, 아니면 login/register 보이도록
				var userName = sessionStorage.getItem("userName");
				if(userName != null && userName != ""){
					document.querySelector("#login").style.display = "none";
					document.querySelector("#mypage").style.display = "";
				}else{
					document.querySelector("#login").style.display = "";
					document.querySelector("#mypage").style.display = "none";
				}
				

				//logout
				document.querySelector("#logout").onclick = function logout(){
					sessionStorage.clear();
					alert("로그아웃 되었습니다");
					document.querySelector("#login").style.display = "";
					document.querySelector("#mypage").style.display = "none";
				}
				
				function searchCode(event){
					var val = event.target.id;
					$.get(root + "/map/aptDeal"
							,{dong: $("#dong").val(), code: val}
							,function(data, status){
								$("#searchResultModal").empty();
								console.log(data);
								$.each(data, function(index, vo) {
									let str = `
										 <tr class="table">
										<td>${index+1}</td>
										<td>${vo.aptName}</td>
										<td>${vo.sidoName} ${vo.gugunName} ${vo.dongName} ${vo.jibun}</td>
										<td>${vo.buildYear}</td>
										<td>${vo.recentPrice}</td>
										</tr>
									`;
									$("#searchResultModal").append(str);
								});
							}
							, "json"
					);

					let modal = new bootstrap.Modal(document.querySelector("#boardInsertModal"), {
			            keyboard: false,
			          });
			          modal.show();
				}
				
				let colorArr = ['table-primary','table-success','table-danger'];
				$(document).ready(function(){
					
					$.get(root + "/map/sido"
						,function(data, status){
							$.each(data, function(index, vo) {
								$("#sido").append("<option value='"+vo.sidoCode+"'>"+vo.sidoName+"</option>");
							});
						}
						, "json"
					);
					
					
				});
				$(document).on("change", "#sido", function() {
					$.get(root + "/map/gugun"
							,{sido: $("#sido").val()}
							,function(data, status){
								$("#gugun").empty();
								$("#gugun").append('<option value="0">선택</option>');
								$.each(data, function(index, vo) {
									$("#gugun").append("<option value='"+vo.gugunCode+"'>"+vo.gugunName+"</option>");
								});
							}
							, "json"
					);
				});
				$(document).on("change", "#gugun", function() {
					$.get(root + "/map/dong"
							,{gugun: $("#gugun").val()}
							,function(data, status){
								$("#dong").empty();
								$("#dong").append('<option value="0">선택</option>');
								$.each(data, function(index, vo) {
									$("#dong").append("<option value='"+vo.dongCode+"'>"+vo.dongName+"</option>");
								});
							}
							, "json"
					);
				});
				$(document).on("change", "#dong", function() {
					$.get(root + "/map/aptName"
							,{dong: $("#dong").val()}
							,function(data, status){
								$("tbody").empty();
								$.each(data, function(index, vo) {
									let str = `
										<tr class="table">
										<td value=${vo.aptCode} id=${vo.aptCode} style="cursor:pointer;" onclick="searchCode(event)"><b>${vo.aptName}</b> <small>(${vo.buildYear})</small></td></tr> 								
									`;
									$("tbody").append(str);
								});
								displayMarkers(data);
							}
							, "json"
					);
					
				});
				
				
				$(document).on("click", "#aptSearchBtn", function() {
					alert("검색");
					var param = {
							serviceKey:'ll4XZIl2q/Lbq3oW4OOtKvgZddpzKjC46pwslkRCVHgKhlgPOxSuj/Ur5QwNWhfOSNJkO1WDc2LFXQSivp4kHA==',
							pageNo:encodeURIComponent('1'),
							numOfRows:encodeURIComponent('10'),
							LAWD_CD:encodeURIComponent($("#gugun").val()),
							DEAL_YMD:encodeURIComponent('202110')
					};
					$.get('http://openapi.molit.go.kr/OpenAPI_ToolInstallPackage/service/rest/RTMSOBJSvc/getRTMSDataSvcAptTradeDev'
							,param
							,function(data, status){
						console.log(data);
								var items = $(data).find('item');
								var jsonArray = new Array();
								items.each(function() {
									var jsonObj	= new Object();
									jsonObj.aptCode = $(this).find('일련번호').text();
									jsonObj.aptName = $(this).find('아파트').text();
									jsonObj.dongCode = $(this).find('법정동읍면동코드').text();
									//jsonObj.dongName = $(this).find('').text();
									//jsonObj.sidoName = $(this).find('').text();
									//jsonObj.gugunName = $(this).find('').text();
									jsonObj.buildYear = $(this).find('건축년도').text();
									jsonObj.jibun = $(this).find('지번').text();
									jsonObj.recentPirce = $(this).find('거래금액').text();
										
									jsonObj = JSON.stringify(jsonObj);
									//String 형태로 파싱한 객체를 다시 json으로 변환
									jsonArray.push(JSON.parse(jsonObj));
								});
								console.log(jsonArray);
								//displayMarkers(jsonArray);
							}
							, "xml"
					);
					
					
					var xhr = new XMLHttpRequest();
					var url = 'http://openapi.molit.go.kr/OpenAPI_ToolInstallPackage/service/rest/RTMSOBJSvc/getRTMSDataSvcAptTradeDev';
					var queryParams = '?' + encodeURIComponent('serviceKey') + '='+encodeURIComponent('ll4XZIl2q/Lbq3oW4OOtKvgZddpzKjC46pwslkRCVHgKhlgPOxSuj/Ur5QwNWhfOSNJkO1WDc2LFXQSivp4kHA==');
					queryParams += '&' + encodeURIComponent('pageNo') + '=' + encodeURIComponent('1'); 
					queryParams += '&' + encodeURIComponent('numOfRows') + '=' + encodeURIComponent('10'); 
					queryParams += '&' + encodeURIComponent('LAWD_CD') + '=' + encodeURIComponent($("#gugun").val()); 
					queryParams += '&' + encodeURIComponent('DEAL_YMD') + '=' + encodeURIComponent('202110'); 
					xhr.open('GET', url + queryParams);
					xhr.onreadystatechange = function () {
					    if (this.readyState == 4) {
					    	console.log(this.responseXML);
					        alert('Status: '+this.status+'nHeaders: '+JSON.stringify(this.getAllResponseHeaders())+'nBody: '+this.responseText);
					    }
					};

					xhr.send('');
				});
				</script>
				</div>
			</div>
		</section>
	</div>
</body>
</html>